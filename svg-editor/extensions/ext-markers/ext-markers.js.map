{"version":3,"file":"ext-markers.js","sources":["../../../../src/editor/extensions/ext-markers/ext-markers.js"],"sourcesContent":["/**\r\n * @file ext-markers.js\r\n *\r\n * @license Apache-2.0\r\n *\r\n * @copyright 2010 Will Schleter based on ext-arrows.js by Copyright(c) 2010 Alexis Deveria\r\n * @copyright 2021 OptimistikSAS\r\n *\r\n * This extension provides for the addition of markers to the either end\r\n * or the middle of a line, polyline, path, polygon.\r\n *\r\n * Markers are graphics\r\n *\r\n * to simplify the coding and make the implementation as robust as possible,\r\n * markers are not shared - every object has its own set of markers.\r\n * this relationship is maintained by a naming convention between the\r\n * ids of the markers and the ids of the object\r\n *\r\n * The following restrictions exist for simplicty of use and programming\r\n *    objects and their markers to have the same color\r\n *    marker size is fixed\r\n *    an application specific attribute - se_type - is added to each marker element\r\n *        to store the type of marker\r\n *\r\n * @todo\r\n *    remove some of the restrictions above\r\n *\r\n*/\r\n\r\nexport default {\r\n  name: 'markers',\r\n  async init () {\r\n    const svgEditor = this\r\n    const { svgCanvas } = svgEditor\r\n    const { BatchCommand, RemoveElementCommand, InsertElementCommand } = svgCanvas.history\r\n    const { $id, addSVGElementsFromJson: addElem } = svgCanvas\r\n    const mtypes = ['start', 'mid', 'end']\r\n    const markerElems = ['line', 'path', 'polyline', 'polygon']\r\n\r\n    // note - to add additional marker types add them below with a unique id\r\n    // and add the associated icon(s) to marker-icons.svg\r\n    // the geometry is normalized to a 100x100 box with the origin at lower left\r\n    // Safari did not like negative values for low left of viewBox\r\n    // remember that the coordinate system has +y downward\r\n    const markerTypes = {\r\n      nomarker: {},\r\n      leftarrow:\r\n        { element: 'path', attr: { d: 'M0,50 L100,90 L70,50 L100,10 Z' } },\r\n      rightarrow:\r\n        { element: 'path', attr: { d: 'M100,50 L0,90 L30,50 L0,10 Z' } },\r\n      box:\r\n        { element: 'path', attr: { d: 'M20,20 L20,80 L80,80 L80,20 Z' } },\r\n      mcircle:\r\n        { element: 'circle', attr: { r: 30, cx: 50, cy: 50 } }\r\n    };\r\n\r\n    // duplicate shapes to support unfilled (open) marker types with an _o suffix\r\n    ['leftarrow', 'rightarrow', 'box', 'mcircle'].forEach((v) => {\r\n      markerTypes[v + '_o'] = markerTypes[v]\r\n    })\r\n\r\n    /**\r\n    * @param {Element} elem - A graphic element will have an attribute like marker-start\r\n    * @param {\"marker-start\"|\"marker-mid\"|\"marker-end\"} attr\r\n    * @returns {Element} The marker element that is linked to the graphic element\r\n    */\r\n    const getLinked = (elem, attr) => {\r\n      const str = elem.getAttribute(attr)\r\n      if (!str) { return null }\r\n      const m = str.match(/\\(#(.*)\\)/)\r\n      // \"url(#mkr_end_svg_1)\" would give m[1] = \"mkr_end_svg_1\"\r\n      if (!m || m.length !== 2) {\r\n        return null\r\n      }\r\n      return svgCanvas.getElement(m[1])\r\n    }\r\n\r\n    /**\r\n     * Toggles context tool panel off/on.\r\n     * @param {boolean} on\r\n     * @returns {void}\r\n    */\r\n    const showPanel = (on, elem) => {\r\n      $id('marker_panel').style.display = (on) ? 'block' : 'none'\r\n      if (on && elem) {\r\n        mtypes.forEach((pos) => {\r\n          const marker = getLinked(elem, 'marker-' + pos)\r\n          if (marker?.attributes?.se_type) {\r\n            $id(`${pos}_marker_list_opts`).setAttribute('value', marker.attributes.se_type.value)\r\n          } else {\r\n            $id(`${pos}_marker_list_opts`).setAttribute('value', 'nomarker')\r\n          }\r\n        })\r\n      }\r\n    }\r\n\r\n    /**\r\n    * @param {string} id\r\n    * @param {\"\"|\"nomarker\"|\"nomarker\"|\"leftarrow\"|\"rightarrow\"|\"textmarker\"|\"forwardslash\"|\"reverseslash\"|\"verticalslash\"|\"box\"|\"star\"|\"xmark\"|\"triangle\"|\"mcircle\"} seType\r\n    * @returns {SVGMarkerElement}\r\n    */\r\n    const addMarker = (id, seType) => {\r\n      const selElems = svgCanvas.getSelectedElements()\r\n      let marker = svgCanvas.getElement(id)\r\n      if (marker) { return undefined }\r\n      if (seType === '' || seType === 'nomarker') { return undefined }\r\n      const el = selElems[0]\r\n      const color = el.getAttribute('stroke')\r\n      const strokeWidth = 10\r\n      const refX = 50\r\n      const refY = 50\r\n      const viewBox = '0 0 100 100'\r\n      const markerWidth = 5\r\n      const markerHeight = 5\r\n\r\n      if (!markerTypes[seType]) {\r\n        console.error(`unknown marker type: ${seType}`)\r\n        return undefined\r\n      }\r\n\r\n      // create a generic marker\r\n      marker = addElem({\r\n        element: 'marker',\r\n        attr: {\r\n          id,\r\n          markerUnits: 'strokeWidth',\r\n          orient: 'auto',\r\n          style: 'pointer-events:none',\r\n          se_type: seType\r\n        }\r\n      })\r\n\r\n      const mel = addElem(markerTypes[seType])\r\n      const fillcolor = (seType.substr(-2) === '_o')\r\n        ? 'none'\r\n        : color\r\n\r\n      mel.setAttribute('fill', fillcolor)\r\n      mel.setAttribute('stroke', color)\r\n      mel.setAttribute('stroke-width', strokeWidth)\r\n      marker.append(mel)\r\n\r\n      marker.setAttribute('viewBox', viewBox)\r\n      marker.setAttribute('markerWidth', markerWidth)\r\n      marker.setAttribute('markerHeight', markerHeight)\r\n      marker.setAttribute('refX', refX)\r\n      marker.setAttribute('refY', refY)\r\n      svgCanvas.findDefs().append(marker)\r\n\r\n      return marker\r\n    }\r\n\r\n    /**\r\n    * @param {Element} elem\r\n    * @returns {SVGPolylineElement}\r\n    */\r\n    const convertline = (elem) => {\r\n      // this routine came from the connectors extension\r\n      // it is needed because midpoint markers don't work with line elements\r\n      if (elem.tagName !== 'line') { return elem }\r\n\r\n      // Convert to polyline to accept mid-arrow\r\n      const x1 = Number(elem.getAttribute('x1'))\r\n      const x2 = Number(elem.getAttribute('x2'))\r\n      const y1 = Number(elem.getAttribute('y1'))\r\n      const y2 = Number(elem.getAttribute('y2'))\r\n      const { id } = elem\r\n\r\n      const midPt = (' ' + ((x1 + x2) / 2) + ',' + ((y1 + y2) / 2) + ' ')\r\n      const pline = addElem({\r\n        element: 'polyline',\r\n        attr: {\r\n          points: (x1 + ',' + y1 + midPt + x2 + ',' + y2),\r\n          stroke: elem.getAttribute('stroke'),\r\n          'stroke-width': elem.getAttribute('stroke-width'),\r\n          fill: 'none',\r\n          opacity: elem.getAttribute('opacity') || 1\r\n        }\r\n      })\r\n      mtypes.forEach((pos) => { // get any existing marker definitions\r\n        const nam = 'marker-' + pos\r\n        const m = elem.getAttribute(nam)\r\n        if (m) { pline.setAttribute(nam, elem.getAttribute(nam)) }\r\n      })\r\n\r\n      const batchCmd = new BatchCommand()\r\n      batchCmd.addSubCommand(new RemoveElementCommand(elem, elem.parentNode))\r\n      batchCmd.addSubCommand(new InsertElementCommand(pline))\r\n\r\n      elem.insertAdjacentElement('afterend', pline)\r\n      elem.remove()\r\n      svgCanvas.clearSelection()\r\n      pline.id = id\r\n      svgCanvas.addToSelection([pline])\r\n      svgCanvas.addCommandToHistory(batchCmd)\r\n      return pline\r\n    }\r\n\r\n    /**\r\n    *\r\n    * @returns {void}\r\n    */\r\n    const setMarker = (pos, markerType) => {\r\n      const selElems = svgCanvas.getSelectedElements()\r\n      if (selElems.length === 0) return\r\n      const markerName = 'marker-' + pos\r\n      const el = selElems[0]\r\n      const marker = getLinked(el, markerName)\r\n      if (marker) { marker.remove() }\r\n      el.removeAttribute(markerName)\r\n      let val = markerType\r\n      if (val === '') { val = 'nomarker' }\r\n      if (val === 'nomarker') {\r\n        svgCanvas.call('changed', selElems)\r\n        return\r\n      }\r\n      // Set marker on element\r\n      const id = 'mkr_' + pos + '_' + el.id\r\n      addMarker(id, val)\r\n      svgCanvas.changeSelectedAttribute(markerName, 'url(#' + id + ')')\r\n      if (el.tagName === 'line' && pos === 'mid') {\r\n        convertline(el)\r\n      }\r\n      svgCanvas.call('changed', selElems)\r\n    }\r\n\r\n    /**\r\n     * Called when the main system modifies an object. This routine changes\r\n     *   the associated markers to be the same color.\r\n     * @param {Element} elem\r\n     * @returns {void}\r\n    */\r\n    const colorChanged = (elem) => {\r\n      const color = elem.getAttribute('stroke')\r\n\r\n      mtypes.forEach((pos) => {\r\n        const marker = getLinked(elem, 'marker-' + pos)\r\n        if (!marker) { return }\r\n        if (!marker.attributes.se_type) { return } // not created by this extension\r\n        const ch = marker.lastElementChild\r\n        if (!ch) { return }\r\n        const curfill = ch.getAttribute('fill')\r\n        const curstroke = ch.getAttribute('stroke')\r\n        if (curfill && curfill !== 'none') { ch.setAttribute('fill', color) }\r\n        if (curstroke && curstroke !== 'none') { ch.setAttribute('stroke', color) }\r\n      })\r\n    }\r\n\r\n    /**\r\n    * Called when the main system creates or modifies an object.\r\n    * Its primary purpose is to create new markers for cloned objects.\r\n    * @param {Element} el\r\n    * @returns {void}\r\n    */\r\n    const updateReferences = (el) => {\r\n      const selElems = svgCanvas.getSelectedElements()\r\n      mtypes.forEach((pos) => {\r\n        const markerName = 'marker-' + pos\r\n        const marker = getLinked(el, markerName)\r\n        if (!marker || !marker.attributes.se_type) { return } // not created by this extension\r\n        const url = el.getAttribute(markerName)\r\n        if (url) {\r\n          const len = el.id.length\r\n          const linkid = url.substr(-len - 1, len)\r\n          if (el.id !== linkid) {\r\n            const newMarkerId = 'mkr_' + pos + '_' + el.id\r\n            addMarker(newMarkerId, marker.attributes.se_type.value)\r\n            svgCanvas.changeSelectedAttribute(markerName, 'url(#' + newMarkerId + ')')\r\n            svgCanvas.call('changed', selElems)\r\n          }\r\n        }\r\n      })\r\n    }\r\n\r\n    return {\r\n      name: svgEditor.i18next.t(`${name}:name`),\r\n      // The callback should be used to load the DOM with the appropriate UI items\r\n      callback () {\r\n        // Add the context panel and its handler(s)\r\n        const panelTemplate = document.createElement('template')\r\n        // create the marker panel\r\n        let innerHTML = '<div id=\"marker_panel\">'\r\n        mtypes.forEach((pos) => {\r\n          innerHTML += `<se-list id=\"${pos}_marker_list_opts\" title=\"tools.${pos}_marker_list_opts\" label=\"\" width=\"22px\" height=\"22px\">`\r\n          Object.entries(markerTypes).forEach(([marker, _mkr]) => {\r\n            innerHTML += `<se-list-item id=\"mkr_${pos}_${marker}\" value=\"${marker}\" title=\"tools.mkr_${marker}\" src=\"${marker}.svg\" img-height=\"22px\"></se-list-item>`\r\n          })\r\n          innerHTML += '</se-list>'\r\n        })\r\n        innerHTML += '</div>'\r\n        panelTemplate.innerHTML = innerHTML\r\n        $id('tools_top').appendChild(panelTemplate.content.cloneNode(true))\r\n        // don't display the panels on start\r\n        showPanel(false)\r\n        mtypes.forEach((pos) => {\r\n          $id(`${pos}_marker_list_opts`).addEventListener('change', (evt) => {\r\n            setMarker(pos, evt.detail.value)\r\n          })\r\n        })\r\n      },\r\n      selectedChanged (opts) {\r\n        // Use this to update the current selected elements\r\n        if (opts.elems.length === 0) showPanel(false)\r\n        opts.elems.forEach((elem) => {\r\n          if (elem && markerElems.includes(elem.tagName)) {\r\n            if (opts.selectedElement && !opts.multiselected) {\r\n              showPanel(true, elem)\r\n            } else {\r\n              showPanel(false)\r\n            }\r\n          } else {\r\n            showPanel(false)\r\n          }\r\n        })\r\n      },\r\n      elementChanged (opts) {\r\n        const elem = opts.elems[0]\r\n        if (elem && (\r\n          elem.getAttribute('marker-start') ||\r\n          elem.getAttribute('marker-mid') ||\r\n          elem.getAttribute('marker-end')\r\n        )) {\r\n          colorChanged(elem)\r\n          updateReferences(elem)\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n"],"names":["name","init","svgEditor","svgCanvas","BatchCommand","RemoveElementCommand","InsertElementCommand","history","$id","addSVGElementsFromJson","addElem","mtypes","markerElems","markerTypes","nomarker","leftarrow","element","attr","d","rightarrow","box","mcircle","r","cx","cy","forEach","v","getLinked","elem","str","getAttribute","m","match","length","getElement","showPanel","on","style","display","pos","marker","attributes","se_type","setAttribute","value","addMarker","id","seType","selElems","getSelectedElements","undefined","el","color","strokeWidth","refX","refY","viewBox","markerWidth","markerHeight","console","error","markerUnits","orient","mel","fillcolor","substr","append","findDefs","convertline","tagName","x1","Number","x2","y1","y2","midPt","pline","points","stroke","fill","opacity","nam","batchCmd","addSubCommand","parentNode","insertAdjacentElement","remove","clearSelection","addToSelection","addCommandToHistory","setMarker","markerType","markerName","removeAttribute","val","call","changeSelectedAttribute","colorChanged","ch","lastElementChild","curfill","curstroke","updateReferences","url","len","linkid","newMarkerId","i18next","t","callback","panelTemplate","document","createElement","innerHTML","Object","entries","_ref","_mkr","appendChild","content","cloneNode","addEventListener","evt","detail","selectedChanged","opts","elems","includes","selectedElement","multiselected","elementChanged"],"mappings":"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"}